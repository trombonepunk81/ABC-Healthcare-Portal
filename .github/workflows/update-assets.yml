name: Update Assets from Tandem Connect

on:
  repository_dispatch:
    types: [update-assets]

permissions:
  contents: write

jobs:
  update-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update assets
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            const incoming = ${{ toJson(github.event.client_payload) }};
            const maxRetries = 5;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              console.log(`Attempt ${attempt}...`);
              
              try {
                // Pull latest
                execSync('git pull origin main', { stdio: 'inherit' });
                
                // Read existing
                let existing = { assets: [] };
                try {
                  if (fs.existsSync('data/assets.json')) {
                    existing = JSON.parse(fs.readFileSync('data/assets.json', 'utf8'));
                  }
                } catch (e) {
                  console.log('No existing file or parse error, starting fresh');
                }
                
                // Merge
                const assetMap = new Map();
                (existing.assets || []).forEach(a => assetMap.set(a.assetId, a));
                (incoming.assets || []).forEach(a => assetMap.set(a.assetId, a));
                
                const merged = Array.from(assetMap.values())
                  .sort((a, b) => a.assetId.localeCompare(b.assetId));
                
                const output = {
                  lastUpdated: new Date().toISOString(),
                  totalAssets: merged.length,
                  assets: merged
                };
                
                // Write
                fs.mkdirSync('data', { recursive: true });
                fs.writeFileSync('data/assets.json', JSON.stringify(output, null, 2));
                
                console.log(`Merged ${incoming.assets?.length || 0} incoming, total now: ${merged.length}`);
                
                // Commit and push
                execSync('git config user.name "github-actions[bot]"');
                execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
                execSync('git add data/assets.json');
                
                try {
                  execSync('git diff --staged --quiet');
                  console.log('No changes to commit');
                  return;
                } catch (e) {
                  // There are changes, continue
                }
                
                execSync('git commit -m "Update assets from Tandem Connect"');
                execSync('git push', { stdio: 'inherit' });
                
                console.log('Success!');
                return;
                
              } catch (error) {
                console.log(`Attempt ${attempt} failed: ${error.message}`);
                if (attempt < maxRetries) {
                  execSync('git reset --hard origin/main');
                  await new Promise(r => setTimeout(r, 2000 + Math.random() * 3000));
                }
              }
            }
            
            throw new Error('Failed after max retries');
