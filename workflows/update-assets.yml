name: Update Assets from Tandem Connect

# This workflow is triggered by a repository_dispatch event from Tandem Connect
on:
  repository_dispatch:
    types: [update-assets]
  
  # Also allow manual triggering for testing
  workflow_dispatch:
    inputs:
      sample_data:
        description: 'Use sample data for testing'
        required: false
        default: 'false'

jobs:
  update-assets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create data directory if it doesn't exist
        run: mkdir -p data
      
      - name: Process webhook data and update assets.json
        run: |
          echo "Processing asset data from Tandem Connect..."
          
          # The webhook payload comes in as github.event.client_payload
          # We'll create the assets.json file from this data
          
          cat > data/assets.json << 'EOF'
          {
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "facility": "Abbott MRI D",
            "source": "Tandem Connect Pipeline",
            "assets": ${{ toJSON(github.event.client_payload.assets) }}
          }
          EOF
          
          echo "âœ… Assets file updated"
          echo "Total assets: $(cat data/assets.json | grep -o '"assetId"' | wc -l)"
      
      - name: Validate JSON format
        run: |
          if ! python3 -m json.tool data/assets.json > /dev/null 2>&1; then
            echo "âŒ Invalid JSON format"
            exit 1
          fi
          echo "âœ… JSON format is valid"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add data/assets.json
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update assets from Tandem Connect - $(date +%Y-%m-%d)"
            git push
            echo "âœ… Changes pushed to repository"
          fi
      
      - name: Summary
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- Total Assets: $(cat data/assets.json | grep -o '"assetId"' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Success" >> $GITHUB_STEP_SUMMARY
